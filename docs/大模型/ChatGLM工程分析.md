---
sort: 7
---

# ChatGLM工程分析


* [算法开发手册](https://kg-nlp.github.io/Algorithm-Project-Manual/大模型/ChatGLM工程分析.html)

* [个人知乎](https://www.zhihu.com/people/zhangyj-n)

[TOC]

## 资料

[GLM-130B](https://github.com/THUDM/GLM-130B/blob/main/README_zh.md)

GLM-130B 是一个开源开放的双语（中文和英文）双向稠密模型，拥有1300亿个参数，模型架构采用通用语言模型（GLM）。

[ChatGLM2-6B](https://github.com/THUDM/ChatGLM2-6B)

ChatGLM2-6B 是开源中英双语对话模型 ChatGLM-6B 的第二代版本，在保留了初代模型对话流畅、部署门槛较低等众多优秀特性的基础之上，ChatGLM2-6B 引入了如下新特性：

* **更强大的性能**：基于 ChatGLM 初代模型的开发经验，我们全面升级了 ChatGLM2-6B 的基座模型。ChatGLM2-6B 使用了 GLM 的混合目标函数，经过了 1.4T 中英标识符的预训练与人类偏好对齐训练，评测结果显示，相比于初代模型，ChatGLM2-6B 在 MMLU（+23%）、CEval（+33%）、GSM8K（+571%） 、BBH（+60%）等数据集上的性能取得了大幅度的提升，在同尺寸开源模型中具有较强的竞争力。
* **更长的上下文**：基于 FlashAttention 技术，我们将基座模型的上下文长度（Context Length）由 ChatGLM-6B 的 2K 扩展到了 32K，并在对话阶段使用 8K 的上下文长度训练，允许更多轮次的对话。但当前版本的 ChatGLM2-6B 对单轮超长文档的理解能力有限，我们会在后续迭代升级中着重进行优化。
* **更高效的推理**：基于 Multi-Query Attention 技术，ChatGLM2-6B 有更高效的推理速度和更低的显存占用：在官方的模型实现下，推理速度相比初代提升了 42%，INT4 量化下，6G 显存支持的对话长度由 1K 提升到了 8K。
* **更开放的协议**：ChatGLM2-6B 权重对学术研究完全开放，在获得官方的书面许可后，亦允许商业使用。如果您发现我们的开源模型对您的业务有用，我们欢迎您对下一代模型 ChatGLM3 研发的捐赠。



[2023/07/04] 发布 P-Tuning v2 与 全参数微调脚本，参见 [P-Tuning](https://github.com/THUDM/ChatGLM2-6B/tree/main/ptuning)。

[ChatGLM 的 Prompt 工程实践教程](https://lslfd0slxc.feishu.cn/docx/Nqm9dX81hotVYUxFQuxcVR82n2g)


## 部署
* ### 网页端启动

```bash

ln -s /opt/conda/bin/streamlit /usr/local/bin/streamlit
streamlit run web_demo2.py --server.port 8003
网页访问:
访问 http://10.0.79.103:7020
```

```
post请求
curl -X POST "http://10.0.79.103:7030/chatglm" \
     -H 'Content-Type: application/json' \
     -d '{"prompt": "你好", "history": []}'
```


* ### API请求
  
  * url: http://10.0.79.103:8001/chatglm
  * 请求格式: 
  
  ```
    {
        "prompt":"",
        "history": [],
        "max_length": "",
        "top_p":"",
        "temperature":""
    }
  ```
  * 返回格式:
  ```
     {
    "response": "。",
    "history": [
        [
            "",
            ""
        ]
    ],
    "status": 200,
    "time": "2023-07-25 09:47:00"
    }
  ```
  
  * 请求示例

```python
	# -*- coding:utf-8 -*-
'''
# @FileName    :request.py
---------------------------------
# @Time        :2023/7/25 
# @Author      :
# @Email       :
---------------------------------
# 目标任务 :   chatglm-2-6b 和 baichuan13b 模型服务
# 二期环境: 10.0.79.103
# chatglm-2-6b 网页端  http://10.0.79.103:7020
# baichuan13b 网页端  http://10.0.79.103:7000
---------------------------------
'''

import json
import requests
headers = {
  "Content-Type": "application/json"
}
def get_chatglm_info(data:dict)->dict:
    raw_data = json.dumps(data)
    res = requests.post("http://10.0.79.103:7030/chatglm",headers=headers, data=raw_data)  # ChatGLM访问

    result = json.loads(res.text)
    print(json.dumps(result,indent=False,ensure_ascii=False))
    return result

def get_baichuan_info(data:dict)->dict:
    raw_data = json.dumps(data)
    res = requests.post("http://10.0.79.103:7010/baichuan",headers=headers, data=raw_data)  # baichuan访问

    result = json.loads(res.text)
    print(json.dumps(result,indent=False,ensure_ascii=False))
    return result



if __name__ == "__main__":

    # chatglm请求示例
    chatglm_data = {
        "prompt":"",
        "history": [],
        "max_length": "",
        "top_p":"",
        "temperature":""
    }

    # baichuan请求示例
    baichuan_data = {
        "prompt":""
    }

    get_chatglm_info(chatglm_data)
    get_baichuan_info(baichuan_data)
```



## prompt设计-ChatGLM2-6B



* Prompt万能公式： 任务+生成主体+细节（可选）+形式（可选）
* 原则一:编写清晰,具体的指令
  - 可以使用更长的指令,分行编写
  - 使用明显的分隔符**待解析的文本**和**prompt**区分开,分隔符可以使用`''',<>,<tag>,<\tag>`等
      - 比如:三个反引号括起来的文本
  - 结构化输出
      - 比如json: 以JSON格式提供,其中包含以下键:xxx,xxx,xxx
  - 要求模型检查是否满足条件,给出其他解,防止模型自由发挥
      - 比如: 如果文本无法接下,则直接输出xxx
  - 提供少量示例
      - 模仿输出风格,few-shot任务
- 原则二:给模型时间思考
    - 将一个任务拆开几步去解决,理解过程,输出结果
    - 涉及计算方案比较,先让模型自己解决,再去做对比(给出模型怎么比较的流程prompt)
    - 模型预测有一定的局限性,会生成一些虚假知识,最好提示模型找到文本中的一些引用,根据引用进行回答，或者进行模型检查其他另外说明。



### 生成同义句

> 输入英文更加稳定点

```text
prompt = '''
    1 You need to generate one semantically identical statements based on the information in <>.
    2 The generated statements cannot exceed 128 words.
    3 Don't repeat sentences, you can replace some keywords.
    4 Unless otherwise specified, please use Chinese.
    5 Generate 1 sentences.

    Context:<>
    
    ''' text
    
prompt = '''
    1.您需要根据<>中的信息生成一个语义相同的语句。
    2.生成的语句不能超过128个单词。
    3.不要有大量重复句子，可以替换一些关键词。
    4.除非另有说明，请使用中文。
    5.生成1个句子。

    Context:<>

    ''' text
```



### 分类任务

> 类别要明确,示例要给全, 结果可能会把"输出类别"这几个字带出
> 行与行之间不要有太多的空行,示例和最后输出中间用---隔开

```
你是一名自然语言处理工程师，负责开发一个文本分类模型，该模型可以将电影评论分为正面和负面两类。
请根据以下上下文和输入，对文本进行分类，并给出相应的输出类别。
不要有多余的字符输出,最多输出两个字。
---
示例：
输入文本：这部电影真是太精彩了！演员表现出色，剧情扣人心弦，强烈推荐！
输出类别：正面
示例:
输入文本: 这个场景太平淡了,不会再看了
输出类别: 负面
---
输入文本：这部电影的演员演的还不错,我会推荐给别人看的,强烈推荐
输出类别：
```



### 意图理解任务-信息抽取

> 参考上述设计链接

* prompt设计的结构

  - 用户输入：将用户输入的内容拼接到prompt中，提交给大模型

  - 身份定义：定义大模型扮演角色，帮助大模型理解指令

  - 背景说明：明确对话发生的背景信息，帮助大模型理解指令

  - 字段说明：说明要提取的字段的含义，以及字段存在的枚举值

  - 输出示例：输出内容示例

  - prompt内容

```python
"""
你是一个智能助理，你需要帮用户结构化记录生日信息、物品存放信息、月经信息
用户输入是一句非常口语化的指令，你需要记录用户指令，并从用户的指令中结构化的输出提取出信息
输出完毕后结束，不要生成新的用户输入，不要新增内容

1.提取话题，话题只能是：生日、纪念日、月经、物品存放。
2.提取目的，目的只能是：记录、预测、查询、庆祝、设置、记录物品、拿到物品、寻找、删除、修改。
3.提取人物，人物指：过生日的人物、过纪念日的人物、来月经的人物、放物品的人物。输出只能是：我，爸爸、妈妈、孩子、爱人、恋人、朋友、哥哥、姐姐。没有写“无”
4.提取人关系，关系指人物与用户的关系，关系只能是：本人、亲人、配偶、朋友、未知、待查询。没有写“无”
5.提取时间，比如：今天、3月1日、上个月、农历二月初六、待查询。没有写“无”
6.提取时间类型，时间类型只能是：过生日的时间、过纪念日的时间、月经开始时间、月经结束时间。 没有写“无”
7.提取物品，比如：衣服、鞋子、书、电子产品、其它。
8.提取物品对应位置，比如：衣柜、书柜、鞋柜、电子产品柜、待查询。
9.按示例结构输出内容，结束

用户：例假昨天结束了
话题：月经
目的：记录
人物：我
关系：本人
时间：昨天
时间类型：月经开始时间
物品：无
位置：无

用户：今天我过生日
话题：生日
目的：记录
人物：我
关系：本人
时间：今天
时间类型：生日时间
物品：无
位置：无

用户：每年的七月二十二日张派生日记录一下
话题：生日
目的：记录
人物：张派
关系：未知
时间：七月二十二日
时间类型：生日时间
物品：无
位置：无

用户：恋爱纪念日
话题：纪念日
目的：查询
人物：我
关系：本人
时间：待查询
时间类型：纪念日时间
物品：无
位置：无

用户：明天提醒我今天来过生日
话题：生日
目的：提醒
人物：我
关系：本人
时间：今天
时间类型：生日时间
物品：无
位置：无

用户：五月十九号提醒我五月二十四宝宝生日
话题：生日
目的：提醒
人物：宝宝
关系：亲人
时间：5月二十四日
时间类型：生日时间
物品：无
位置：无

用户：大姨妈结束了
话题：月经
目的：记录
人物：我
关系：本人
时间：今天
时间类型：月经结束时间
物品：无
位置：无

用户：月经数据
话题：月经
目的：查询
人物：我
关系：本人
时间：无
时间类型：无
物品：无
位置：无

用户：我大姨妈啥时候来
话题：月经
目的：查询
人物：我
关系：本人
时间：待查询
时间类型：月经开始时间
物品：无
位置：无

用户：今天是我的生理期哟
话题：月经
目的：记录
人物：我
关系：本人
时间：今天
时间类型：月经开始时间
物品：无
位置：无

用户:<>
"""text
```



### 指令系统-结构化指令信息(6B能力有限,大模型更好)

* 场景描述

  * 车载场景中，用户通过语音交互实现车控、播放音乐、导航等功能。
  * 有效识别简单、复杂场景的用户口语化指令，并**结构化**输出指令的信息。

* 业务要求

  * 指令包含**触发条件和执行动作**
  * **一句话多意图**：需准确拆分识别多个意图，并按顺序输出

* prompt设计

    * Part 1 — 赋予大模型角色，清晰凝练的描述任务

    告知角色：你是文字提取器（💡选择好的角色有助于大模型对任务的理解）

    告知任务：你要结构化的提取用户描述中动作和条件  

    明晰定义字段：给出条件、动作等字段的具体含义（💡给一些示例有助于识别字段） (缓解无法识别具体条件信息)

    * Part 2 — Few Shots 

    给出示例：期望大模型输出的结果（💡示例的选取很重要，关注典型的、不同分类的）(可以缓解多意图识别效果不佳)

    * Part 3 — 引导输出 和 最后的叮嘱

    按格式输出：使用“ 用户输入： ”作为强引导要求大模型按照格式输出

    最后的叮嘱：在整个prompt尾部再次强调任务（💡尾部的语句约束性较高，可斟酌此处的语句，一般为任务，也可以是根据输出表现优化的小要求）

* prompt内容

```python
"""
这是文字提取器，你要结构化的提取用户描述中动作和条件。
条件是指：某个事件或者行动所需要满足的一些前提条件或要求，如：10分钟后，车内温度降至15度后、到达目的地后、无。条件可以有多个。没有写“无”。
动作是指：对某个动作进行命令或描述。如：打开空调、关闭窗户、播放音乐、提醒我买菜、导航到目的地、保持空调保持26度、无。动作可以有多个。
输出完毕后结束，不要生成新的用户输入，不要新增内容

示例：

用户输入：到公司附近后，提醒我买杯美式咖啡

动作1:提醒我买杯美式咖啡
条件1:到公司附近后

用户输入：放学后，播放动画片，若太累了，播放摇篮曲

动作1:播放动画片
条件1:放学后

动作2:播放摇篮曲
条件2:太累了

用户输入：打开车窗，关闭空调，5分钟后关闭车窗，打开空调

动作1:打开车窗
条件1:无

动作2:关闭空调
条件2:无

动作3:关闭车窗
条件3:5分钟后

动作4:打开空调
条件4:无

请根据以下文本，按照模版输出内容。
用户输入：<>
"""text
```

> 在上面的文本框里不能写{}

### 新闻改写

* 场景描述

  * 对**已有背景资料**进行改写，生成本土IC**投资类新闻稿**。

* 业务要求

  * 要求实现改变，并保留重要信息。其中改写要求不构成对原稿件的抄袭；重要信息包括：企业、融资情况和企业情况。

* prompt设计

  * Temperature=0.8    

    Top_P=0.5  （具体取值可根据新闻题材的需求调整）

  * 思路

    * 思路：根据新闻文体特征，规定了格式（标题、正文）和语言风格

    *  思路：针对第1版存在问题做出以下调整：

       A. 总结重要信息，明确提出要求。总的分为企业（主体）、融资情况、企业情况。其中，融资情况包括：融资进度、融资方、融资金额、融资目的等；企业情况包括：名称、业务、团队、发言、核心技术、技术方向、产品进展等。

       B. 要求确保信息的真实性，不允许杜撰。同时明确规定重要信息（人名、物名、数字、日期、行为）不能改动。

       C.调整改写的温度值（0.8）。增加改写规则：可以改变调整信息顺序，必须改变背景资料段落中句子的语法结构、句子长度、词语搭配。

```python
'''
    背景资料：<>
    ---
    你是一个新闻改写人，需要根据背景资料改写新闻。新闻包括"标题"、"正文"，改写发生在正文部分。
    "标题"应该是一个完整的句子，能够概括新闻内容。标题内容由企业和融资情况、融资用途构成。
    "正文"应该第一段说明企业和融资情况（包括融资进度、融资方、融资金额、融资目的）；在之后的段落中，从名称、业务、团队、发言、核心技术、技术方向、产品进展等角度叙述企业情况。若背景资料中没有提到，则忽略。
    改写可以改变调整信息顺序，必须改变背景资料段落中句子的语法结构、句子长度、词语搭配。
    
    你的新闻需要遵守以下规定：
    1.使用的语言简短精炼。
    2.涉及的信息真实，不允许杜撰。
    3.在正文中重新表达背景资料的信息，但是人名、物名、数字、日期、行为不能改动。
    
    输出格式：
    今日新闻：<>
    标题：<>
    正文：<>
''' text
```



### 风格写作

fewshot



### 总结多任务(这种情况不好做)

> 这种任务对于chatglm2-6b来说有些难了,使用130B的没有问题

```python
    解析下面"""括起来的文本。
    1.用一句话概括文本，最多30个词汇，侧重产品价格和质量。
    2.提取摘要
    2.将摘要翻译成英语。
    3.在中文摘要中提取关键词,数量是3个。
    
    请使用以下格式：
    文本：<要总结的原文本>
    摘要：<摘要>
    翻译：<摘要的翻译>
    关键词：<中文摘要中的关键词列表>

    """
    这个熊猫公仔是我给女儿的生日礼物，她很喜欢，去哪都带着。\
    公仔很软，超级可爱，面部表情也很和善。但是相比于价钱来说， \
    它有点小，我感觉在别的地方用同样的价钱能买到更大的。 \
    快递比预期提前了一天到货，所以在送给女儿之前，我自己玩了会。
    """
```
