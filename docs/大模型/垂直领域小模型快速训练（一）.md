---
sort: 12
---

# 垂直领域小模型快速训练（一）

*   [算法开发手册](https://kg-nlp.github.io/Algorithm-Project-Manual/大模型/垂直领域小模型快速训练（一）.html)

*   [个人知乎](https://www.zhihu.com/people/zhangyj-n)

## 背景

承接之前内容
* [垂直领域小模型快速训练](https://kg-nlp.github.io/Algorithm-Project-Manual/大模型/垂直领域小模型快速训练.html)
* [LLM数据处理](https://kg-nlp.github.io/Algorithm-Project-Manual/大模型/LLM数据处理.html)

## 20230714 第一轮数据处理结果

*   数据
    * Total sentences num: 82609   # 按照换行符,句号,问号,叹号分句
    * Total documents num: 2217
    * Total tokens num: 4197617
    * Average tokens per sentence: 50.81
    * Average tokens per document: 1893.38

*   模型训练

| 基础模型                | 超参 |
| ------------------- | -- |
| ernie-3.0-base-zh   |    |
| ernie-3.0-medium-zh |    |
| ernie-3.0-mini-zh   |    |
| ernie-3.0-micro-zh  |    |

```
ernie-3.0-base-zh
12-layer, 768-hidden, 12-heads, 118M parameters. Trained on Chinese text.
ernie-3.0-medium-zh
6-layer, 768-hidden, 12-heads, 75M parameters. Trained on Chinese text.
ernie-3.0-mini-zh
6-layer, 384-hidden, 12-heads, 27M parameters. Trained on Chinese text.
ernie-3.0-micro-zh
4-layer, 384-hidden, 12-heads, 23M parameters. Trained on Chinese text.
ernie-3.0-nano-zh
4-layer, 312-hidden, 12-heads, 18M parameters. Trained on Chinese text.
```

以上模型超参

```bash

MODEL_NAME="ernie-3.0-mini-zh"
MODEL_NAME="ernie-3.0-micro-zh"
MODEL_NAME="ernie-3.0-medium-zh"
MODEL_NAME="ernie-3.0-base-zh"

python -u -m paddle.distributed.launch \
    --gpus "0,1,2,3" \
    --log_dir "output/${MODEL_NAME}/logs" \
    run_pretrain.py \
    --model_name_or_path ${MODEL_NAME} \
    --tokenizer_name_or_path ${MODEL_NAME} \
    --input_dir  /home/Algorithm_Frame/LLM/process/data/CDE工艺数据处理/cde_data \
    --output_dir output/${MODEL_NAME} \
    --split 198,1,1 \
    --binary_head True \
    --max_seq_len 256 \
    --micro_batch_size 128 \
    --max_steps 2400 \
    --checkpoint_steps 240 \
    --save_steps 320 \
    --logging_freq 160 \
    --eval_freq 160

```
* 损失曲线


```
/opt/conda/bin/visualdl service upload --logdir ./output/ernie-3.0-micro-zh/runs/
```
[micro损失](https://paddlepaddle.org.cn/paddle/visualdl/service/app?id=9c1a86b5fcd1d05524aef8ad0d9e8c76)


```
/opt/conda/bin/visualdl service upload --logdir ./output/ernie-3.0-mini-zh/runs/
```
[mini损失](https://paddlepaddle.org.cn/paddle/visualdl/service/app?id=6fef7afb50376cd17457e8f288e85ed1)

```
/opt/conda/bin/visualdl service upload --logdir ./output/ernie-3.0-medium-zh/runs/
```
[medium损失](https://paddlepaddle.org.cn/paddle/visualdl/service/app?id=3b8539ff324f1d9390319a68591b0289)

```
/opt/conda/bin/visualdl service upload --logdir ./output/ernie-3.0-base-zh/runs/
```
[base损失](https://paddlepaddle.org.cn/paddle/visualdl/service/app?id=98eb8620aec6cf36da4251d278d2ed5a)

* 模型对比结果

业务领域训练超参设置

```bash
    --device "gpu" \
    --max_seq_length 128 \
    --model_name pretrain_model/${MODEL_NAME} \
    --batch_size 128 \
    --early_stop_nums 10 \
    --learning_rate 5e-5 \
    --epochs 50
```

| 基础模型 | 增量模型 | 基础模型结果 | 增量模型结果 |
| --- | --- | --- | --- |
| ernie-3.0-micro-zh ep24 | model_ernie_2400_micro ep16  | 成本数据 预测准确率0.775000<br>成本数据 容错预测准确率0.780000<br>质量验收 预测准确率0.819113<br>质量验收 容错预测准确率0.846416<br>进度计划 预测准确率0.899408<br>进度计划 容错预测准确率0.934911<br>总预测准确率0.851000<br>总容错预测准确率0.878000<br> |成本数据 预测准确率0.760<br>成本数据 容错预测准确率0.770<br>质量验收 预测准确率0.802<br>质量验收 容错预测准确率0.823<br>进度计划 预测准确率0.886<br>进度计划 容错预测准确率0.939<br>总预测准确率0.836<br>总容错预测准确率0.871 |
| ernie-3.0-mini-zh  ep28 | model_ernie_2400_mini ep34   |   成本数据 预测准确率0.775000<br>成本数据 容错预测准确率0.775000<br>质量验收 预测准确率0.788396<br>质量验收 容错预测准确率0.832765<br>进度计划 预测准确率0.915187<br>进度计划 容错预测准确率0.950690<br>总预测准确率0.850000<br>总容错预测准确率0.881000<br>     |  成本数据 预测准确率0.790000<br>成本数据 容错预测准确率0.800000<br>质量验收 预测准确率0.843003<br>质量验收 容错预测准确率0.863481<br>进度计划 预测准确率0.905325<br>进度计划 容错预测准确率0.956607<br>总预测准确率0.864000<br>总容错预测准确率0.898000<br> |
| ernie-3.0-medium-zh ep44 | model_ernie_2400_medium ep11 |    成本数据 预测准确率0.760000<br>成本数据 容错预测准确率0.760000<br>质量验收 预测准确率0.825939<br>质量验收 容错预测准确率0.849829<br>进度计划 预测准确率0.927022<br>进度计划 容错预测准确率0.952663<br>总预测准确率0.864000<br>总容错预测准确率0.884000<br>    |  成本数据 预测准确率0.760000<br>成本数据 容错预测准确率0.760000<br>质量验收 预测准确率0.802048<br>质量验收 容错预测准确率0.843003<br>进度计划 预测准确率0.923077<br> 进度计划 容错预测准确率0.950690<br>总预测准确率0.855000<br>总容错预测准确率0.881000 |
| ernie-3.0-base-zh  ep21 | model_ernie_2400_base ep19   |    成本数据 预测准确率0.760000<br>成本数据 容错预测准确率0.770000<br>质量验收 预测准确率0.832765<br>质量验收 容错预测准确率0.866894<br>进度计划 预测准确率0.919132<br>进度计划 容错预测准确率0.942801<br>总预测准确率0.862000<br>总容错预测准确率0.886000<br>    | 成本数据 预测准确率0.770000<br>成本数据 容错预测准确率0.770000<br>质量验收 预测准确率0.829352<br>质量验收 容错预测准确率0.856655<br>进度计划 预测准确率0.923077<br>进度计划 容错预测准确率0.944773<br>总预测准确率0.865000<br>总容错预测准确率0.884000  |


|增量模型 | 增量模型结果|
|---|---|
|model_ernie_1600_micro |成本数据 预测准确率0.760000<br>成本数据 容错预测准确率0.765000<br>质量验收 预测准确率0.788396<br>质量验收 容错预测准确率0.832765<br>进度计划 预测准确率0.923077<br>进度计划 容错预测准确率0.956607<br>总预测准确率0.851000<br>总容错预测准确率0.882000<br>|
|model_ernie_1600_mini ep34|成本数据 预测准确率0.770000<br>成本数据 容错预测准确率0.775000<br>质量验收 预测准确率0.839590<br>质量验收 容错预测准确率0.873720<br>进度计划 预测准确率0.893491<br>进度计划 容错预测准确率0.942801<br>总预测准确率0.853000<br>总容错预测准确率0.889000<br>|
|model_ernie_1600_medium ep17|成本数据 预测准确率0.745000<br>成本数据 容错预测准确率0.750000<br>质量验收 预测准确率0.819113<br>质量验收 容错预测准确率0.843003<br>进度计划 预测准确率0.932939<br>进度计划 容错预测准确率0.958580<br>总预测准确率0.862000<br>总容错预测准确率0.883000<br>|
|model_ernie_1600_base ep26|成本数据 预测准确率0.785000<br>成本数据 容错预测准确率0.790000<br>质量验收 预测准确率0.812287<br>质量验收 容错预测准确率0.856655<br>进度计划 预测准确率0.923077<br>进度计划 容错预测准确率0.956607<br>总预测准确率0.863000<br>总容错预测准确率0.894000<br>|


|增量模型 | 增量模型结果|
|---|---|
|model_ernie_320_micro ep17|成本数据 预测准确率0.750000<br>成本数据 容错预测准确率0.760000<br>质量验收 预测准确率0.815700<br>质量验收 容错预测准确率0.843003<br>进度计划 预测准确率0.899408<br>进度计划 容错预测准确率0.940828<br>总预测准确率0.845000<br>总容错预测准确率0.876000<br>|
|model_ernie_320_mini ep31|成本数据 预测准确率0.750000<br>成本数据 容错预测准确率0.750000<br>质量验收 预测准确率0.808874<br>质量验收 容错预测准确率0.846416<br>进度计划 预测准确率0.923077<br>进度计划 容错预测准确率0.950690<br>总预测准确率0.855000<br>总容错预测准确率0.880000<br>|
|model_ernie_320_medium ep20|成本数据 预测准确率0.775000<br>成本数据 容错预测准确率0.785000<br>质量验收 预测准确率0.832765<br>质量验收 容错预测准确率0.870307<br>进度计划 预测准确率0.923077<br>进度计划 容错预测准确率0.956607<br>总预测准确率0.867000<br>总容错预测准确率0.897000<br>|
|model_ernie_320_base ep15|成本数据 预测准确率0.790000<br>成本数据 容错预测准确率0.795000<br>质量验收 预测准确率0.825939<br>质量验收 容错预测准确率0.846416<br>进度计划 预测准确率0.923077<br>进度计划 容错预测准确率0.942801<br>总预测准确率0.868000<br>总容错预测准确率0.885000<br>|


|增量模型 | 增量模型结果|
|---|---|
|model_ernie_960_micro ep45|成本数据 预测准确率0.770000<br>成本数据 容错预测准确率0.770000<br>质量验收 预测准确率0.822526<br>质量验收 容错预测准确率0.853242<br>进度计划 预测准确率0.881657<br>进度计划 容错预测准确率0.930966<br>总预测准确率0.842000<br>总容错预测准确率0.876000<br>|
|model_ernie_960_mini ep30|成本数据 预测准确率0.730<br>成本数据 容错预测准确率0.740<br>质量验收 预测准确率0.829<br>质量验收 容错预测准确率0.863<br>进度计划 预测准确率0.911<br>进度计划 容错预测准确率0.953<br>总预测准确率0.851<br>总容错预测准确率0.884<br>|
|model_ernie_960_medium ep11|成本数据 预测准确率0.740000<br>成本数据 容错预测准确率0.750000<br>质量验收 预测准确率0.829352<br>质量验收 容错预测准确率0.856655<br>进度计划 预测准确率0.934911<br>进度计划 容错预测准确率0.972387<br>总预测准确率0.865000<br>总容错预测准确率0.894000<br>|
|model_ernie_960_base ep15|成本数据 预测准确率0.805000<br>成本数据 容错预测准确率0.805000<br>质量验收 预测准确率0.836177<br>质量验收 容错预测准确率0.863481<br>进度计划 预测准确率0.928994<br>进度计划 容错预测准确率0.958580<br>总预测准确率0.877000<br>总容错预测准确率0.900000<br>|


<br>

> 表格中ep表示epoch



比较原模型,和增量模型第320step,960step,1600step,2400step模型结果  

比较不同基础模型结果


|模型|基础结果|320结果|960结果|1600结果|2400结果|
|---|---|---|---|---|---|
|micro|总预测准确率0.851<br>总容错预测准确率0.878|总预测准确率0.845<br>总容错预测准确率0.870|总预测准确率0.842<br>总容错预测准确率0.876|总预测准确率0.851<br>总容错预测准确率0.882|总预测准确率0.836<br>总容错预测准确率0.871|
|mini|总预测准确率0.850<br>总容错预测准确率0.881|总预测准确率0.855<br>总容错预测准确率0.880|总预测准确率0.851<br>总容错预测准确率0.884|总预测准确率0.853<br>总容错预测准确率0.889|总预测准确率0.864<br>总容错预测准确率0.898|
|medium|总预测准确率0.864<br>总容错预测准确率0.884|==总预测准确率0.867<br>总容错预测准确率0.897==|==总预测准确率0.865<br>总容错预测准确率0.894==|总预测准确率0.862<br>总容错预测准确率0.883|总预测准确率0.855<br>总容错预测准确率0.881|
|base|总预测准确率0.862<br>总容错预测准确率0.886|总预测准确率0.868<br>总容错预测准确率0.885|总预测准确率0.877<br>总容错预测准确率0.900|总预测准确率0.863<br>总容错预测准确率0.894|总预测准确率0.865<br>总容错预测准确率0.884|

* 结果

第一轮测试结果 选择medium 960结果


* **对比第三/五轮结果**

* 使用31的模型(730版本) 进度 质量 成本 框架>12  bs=128  未增强数据

|数据域|测试集数量|专业识别准确率|分部识别准确率|分项识别准确率|整体匹配准确率|
|---|---|---|---|---|---|
|质量验收|293|0.911| 0.870|0.973 |0.843|
|进度计划|507|0.978| 0.953|0.903 |0.890|
|总|800|0.954| 0.922|0.929 |0.873|

* v31和730版本的模型一样,测试新数据

|数据域|测试集数量|专业识别准确率|分部识别准确率|分项识别准确率|整体匹配准确率|
|---|---|---|---|---|---|
|质量验收|293|0.911| 0.870|0.973 |0.843|
|进度计划|662|0.937| 0.885|0.891 |0.819|
|总|955|0.929| 0.881|0.916 |0.826|

* 使用v7-v33的数据测试

* MODEL_NAME="ernie-3.0-base-zh/model_800"



|数据域|测试集数量|专业识别准确率|分部识别准确率|分项识别准确率|整体匹配准确率|
|---|---|---|---|---|---|
|质量验收|293|0.908| 0.863|0.973 |0.836|
|进度计划|662|0.947| 0.909|0.915 |0.849|
|总|955|0.935| 0.895|0.933 |0.845|



* MODEL_NAME="ernie-3.0-base-zh/model_1600"



|数据域|测试集数量|专业识别准确率|分部识别准确率|分项识别准确率|整体匹配准确率|
|---|---|---|---|---|---|
|质量验收|293|0.918| 0.874|0.976 |0.846|
|进度计划|662|0.946| 0.906|0.903 |0.838|
|总|955|0.937| 0.896|0.926 |0.841|



* MODEL_NAME="model_ernie_2400_medium" ep=88



|数据域|测试集数量|专业识别准确率|分部识别准确率|分项识别准确率|整体匹配准确率|
|---|---|---|---|---|---|
|质量验收|293|0.922| 0.881|0.983 |0.863|
|进度计划|662|0.940| 0.897|0.908 |0.837|
|总|955|0.934| 0.892|0.931 |0.845|



MODEL_NAME="ernie-3.0-medium-zh"  ep=87



|数据域|测试集数量|专业识别准确率|分部识别准确率|分项识别准确率|整体匹配准确率|
|---|---|---|---|---|---|
|质量验收|293|0.918| 0.887|0.966 |0.857|
|进度计划|662|0.931| 0.897|0.897 |0.831|
|总|955|0.927| 0.894|0.918 |0.839|



MODEL_NAME="ernie-3.0-medium-zh/model_800"



|数据域|测试集数量|专业识别准确率|分部识别准确率|分项识别准确率|整体匹配准确率|
|---|---|---|---|---|---|
|质量验收|293|0.891| 0.887|0.980 |0.846|
|进度计划|662|0.938| 0.890|0.906 |0.841|
|总|955|0.924| 0.889|0.929 |0.843|



MODEL_NAME="ernie-3.0-medium-zh/model_1600"



|数据域|测试集数量|专业识别准确率|分部识别准确率|分项识别准确率|整体匹配准确率|
|---|---|---|---|---|---|
|质量验收|293|0.918| 0.887|0.980 |0.853|
|进度计划|662|0.943| 0.893|0.905 |0.831|
|总|955|0.935| 0.891|0.928 |0.838|



MODEL_NAME="ernie-3.0-medium-zh/model_2400"



|数据域|测试集数量|专业识别准确率|分部识别准确率|分项识别准确率|整体匹配准确率|
|---|---|---|---|---|---|
|质量验收|293|0.908| 0.877|0.980 |0.846|
|进度计划|662|0.949| 0.912|0.888 |0.831|
|总|955|0.936| 0.902|0.916 |0.836|



MODEL_NAME="ernie-3.0-medium-zh/model_4000"



|数据域|测试集数量|专业识别准确率|分部识别准确率|分项识别准确率|整体匹配准确率|
|---|---|---|---|---|---|
|质量验收|293|0.915| 0.884|0.973 |0.853|
|进度计划|662|0.946| 0.903|0.894 |0.834|
|总|955|0.936| 0.897|0.918 |0.840|



MODEL_NAME="ernie-3.0-medium-zh/model_4800"



|数据域|测试集数量|专业识别准确率|分部识别准确率|分项识别准确率|整体匹配准确率|
|---|---|---|---|---|---|
|质量验收|293|0.911| 0.881|0.962 |0.857|
|进度计划|662|0.937| 0.890|0.891 |0.820|
|总|955|0.929| 0.887|0.913 |0.831|



MODEL_NAME="ernie-3.0-medium-zh/model_5600"



|数据域|测试集数量|专业识别准确率|分部识别准确率|分项识别准确率|整体匹配准确率|
|---|---|---|---|---|---|
|质量验收|293|0.908| 0.891|0.969 |0.850|
|进度计划|662|0.929| 0.894|0.903 |0.825|
|总|955|0.923| 0.893|0.924 |0.832|



MODEL_NAME="ernie-3.0-medium-zh/model_6400"



|数据域|测试集数量|专业识别准确率|分部识别准确率|分项识别准确率|整体匹配准确率|
|---|---|---|---|---|---|
|质量验收|293|0.904| 0.874|0.980 |0.836|
|进度计划|662|0.931| 0.882|0.890 |0.817|
|总|955|0.923| 0.880|0.917 |0.823|



MODEL_NAME="ernie-3.0-medium-zh/model_8000"



|数据域|测试集数量|专业识别准确率|分部识别准确率|分项识别准确率|整体匹配准确率|
|---|---|---|---|---|---|
|质量验收|293|0.901| 0.884|0.986 |0.843|
|进度计划|662|0.943| 0.894|0.905 |0.840|
|总|955|0.930| 0.891|0.930 |0.841|



MODEL_NAME="ernie-3.0-mini-zh/model_800"



|数据域|测试集数量|专业识别准确率|分部识别准确率|分项识别准确率|整体匹配准确率|
|---|---|---|---|---|---|
|质量验收|293|0.887| 0.870|0.976 |0.819|
|进度计划|662|0.921| 0.870|0.876 |0.764|
|总|955|0.911| 0.870|0.907 |0.781|



MODEL_NAME="ernie-3.0-mini-zh/model_1600"



|数据域|测试集数量|专业识别准确率|分部识别准确率|分项识别准确率|整体匹配准确率|
|---|---|---|---|---|---|
|质量验收|293|0.898| 0.853|0.983 |0.819|
|进度计划|662|0.931| 0.861|0.876 |0.776|
|总|955|0.920| 0.859|0.909 |0.790|



MODEL_NAME="ernie-3.0-mini-zh/model_2400"



|数据域|测试集数量|专业识别准确率|分部识别准确率|分项识别准确率|整体匹配准确率|
|---|---|---|---|---|---|
|质量验收|293|0.904| 0.887|0.973 |0.850|
|进度计划|662|0.935| 0.866|0.872 |0.781|
|总|955|0.926| 0.872|0.903 |0.802|



MODEL_NAME="ernie-3.0-mini-zh/model_4800"



|数据域|测试集数量|专业识别准确率|分部识别准确率|分项识别准确率|整体匹配准确率|
|---|---|---|---|---|---|
|质量验收|293|0.891| 0.860|0.983 |0.819|
|进度计划|662|0.932| 0.876|0.878 |0.785|
|总|955|0.919| 0.871|0.910 |0.796|



MODEL_NAME="ernie-3.0-micro-zh/model_8000"



|数据域|测试集数量|专业识别准确率|分部识别准确率|分项识别准确率|整体匹配准确率|
|---|---|---|---|---|---|
|质量验收|293|0.901| 0.867|0.976 |0.833|
|进度计划|662|0.931| 0.852|0.863 |0.755|
|总|955|0.921| 0.857|0.897 |0.779|

* **对比第五轮结果**

> 第四轮结果测试了一个medium效果差不多,epoch设置为1~2即可



MODEL_NAME="20230817第五轮测试/ernie-3.0-medium-zh/model_600"  (v33)



|数据域|测试集数量|专业识别准确率|分部识别准确率|分项识别准确率|整体匹配准确率|
|---|---|---|---|---|---|
|质量验收|293|0.911| 0.891|0.976 |0.863|
|进度计划|662|0.940| 0.914|0.915 |0.843|
|总|955|0.931| 0.907|0.934 |0.849|



MODEL_NAME="20230817第五轮测试/ernie-3.0-medium-zh/model_800"



|数据域|测试集数量|专业识别准确率|分部识别准确率|分项识别准确率|整体匹配准确率|
|---|---|---|---|---|---|
|质量验收|293|0.918| 0.894|0.980 |0.860|
|进度计划|662|0.941| 0.903|0.896 |0.831|
|总|955|0.934| 0.901|0.921 |0.840|



MODEL_NAME="20230817第五轮测试/ernie-3.0-medium-zh/model_1200"



|数据域|测试集数量|专业识别准确率|分部识别准确率|分项识别准确率|整体匹配准确率|
|---|---|---|---|---|---|
|质量验收|293|0.915| 0.894|0.976 |0.857|
|进度计划|662|0.944| 0.903|0.902 |0.832|
|总|955|0.935| 0.901|0.925 |0.840|



MODEL_NAME="20230817第五轮测试/ernie-3.0-medium-zh/model_1800"



|数据域|测试集数量|专业识别准确率|分部识别准确率|分项识别准确率|整体匹配准确率|
|---|---|---|---|---|---|
|质量验收|293|0.922| 0.884|0.973 |0.853|
|进度计划|662|0.940| 0.897|0.908 |0.840|
|总|955|0.934| 0.893|0.928 |0.844|



v35 两科目一清单  (可用,效果很好,分隔符用逗号,没有去除个别关键词)



|数据域|测试集数量|专业识别准确率|分部识别准确率|分项识别准确率|整体匹配准确率|
|---|---|---|---|---|---|
|质量验收|293|0.915| 0.901|0.969 |0.867|
|进度计划|662|0.944| 0.909|0.917 |0.850|
|总|955|0.935| 0.907|0.933 |0.855|



v36 成本科目数据增加



| 数据域   | 测试集数量 | 专业识别准确率 | 分部识别准确率 | 分项识别准确率 | 整体匹配准确率 |
| -------- | ---------- | -------------- | -------------- | -------------- | -------------- |
| 成本数据 | 300        | 0.937          | 0.887          | 0.973          | 0.867          |
| 质量验收 | 293        | 0.904          | 0.894          | 0.980          | 0.857          |
| 进度计划 | 662        | 0.953          | 0.911          | 0.900          | 0.843          |
| 总       | 1255       | 0.938          | 0.901          | 0.936          | 0.852          |